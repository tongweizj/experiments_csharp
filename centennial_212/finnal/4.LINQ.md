# 基于 Entity Framework Core (SqlServer) 的基本 LINQ 操作指南

下面我将介绍使用 `Microsoft.EntityFrameworkCore.SqlServer` 和 `Microsoft.EntityFrameworkCore.Tools` 进行基本 LINQ 操作的方法，包括安装、配置和常见查询模式。

## 1. 安装与配置

### 安装 NuGet 包
```bash
Install-Package Microsoft.EntityFrameworkCore.SqlServer
Install-Package Microsoft.EntityFrameworkCore.Tools
```

### DbContext 配置
```csharp
public class AppDbContext : DbContext
{
    public DbSet<Product> Products { get; set; }
    public DbSet<Category> Categories { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer(
            @"Server=(localdb)\mssqllocaldb;Database=MyShopDB;Trusted_Connection=True;");
    }
}
```

## 2. 基本 CRUD 操作

### 创建 (Create)
```csharp
using (var context = new AppDbContext())
{
    var category = new Category { Name = "电子产品" };
    context.Categories.Add(category);
    
    var product = new Product 
    { 
        Name = "笔记本电脑", 
        Price = 5999, 
        Category = category 
    };
    context.Products.Add(product);
    
    await context.SaveChangesAsync();
}
```

### 读取 (Read)
#### 基本查询
```csharp
// 获取所有产品
var products = await context.Products.ToListAsync();

// 获取单个产品
var product = await context.Products
    .FirstOrDefaultAsync(p => p.Id == 1);

// 带条件的查询
var expensiveProducts = await context.Products
    .Where(p => p.Price > 1000)
    .ToListAsync();
```

#### 包含关联数据 (Eager Loading)
```csharp
var productsWithCategory = await context.Products
    .Include(p => p.Category)  // 加载关联的Category
    .ToListAsync();
```

### 更新 (Update)
```csharp
var product = await context.Products.FindAsync(1);
if (product != null)
{
    product.Price = 5499; // 降价促销
    await context.SaveChangesAsync();
}
```

### 删除 (Delete)
```csharp
var product = await context.Products.FindAsync(1);
if (product != null)
{
    context.Products.Remove(product);
    await context.SaveChangesAsync();
}
```

## 3. 常见 LINQ 查询模式

### 排序 (Ordering)
```csharp
// 升序
var productsAsc = await context.Products
    .OrderBy(p => p.Price)
    .ToListAsync();

// 降序
var productsDesc = await context.Products
    .OrderByDescending(p => p.Price)
    .ToListAsync();

// 多列排序
var productsMultiSort = await context.Products
    .OrderBy(p => p.Category.Name)
    .ThenByDescending(p => p.Price)
    .ToListAsync();
```

### 分页 (Pagination)
```csharp
int pageNumber = 1;
int pageSize = 10;

var pagedProducts = await context.Products
    .Skip((pageNumber - 1) * pageSize)
    .Take(pageSize)
    .ToListAsync();
```

### 聚合函数 (Aggregation)
```csharp
// 计数
var count = await context.Products.CountAsync();

// 条件计数
var expensiveCount = await context.Products
    .CountAsync(p => p.Price > 1000);

// 求和
var totalValue = await context.Products
    .SumAsync(p => p.Price);

// 平均值
var avgPrice = await context.Products
    .AverageAsync(p => p.Price);

// 最大值/最小值
var maxPrice = await context.Products
    .MaxAsync(p => p.Price);
    
var minPrice = await context.Products
    .MinAsync(p => p.Price);
```

### 分组 (Grouping)
```csharp
var productsByCategory = await context.Products
    .GroupBy(p => p.Category.Name)
    .Select(g => new 
    {
        CategoryName = g.Key,
        Count = g.Count(),
        TotalPrice = g.Sum(p => p.Price)
    })
    .ToListAsync();
```

### 连接查询 (Joins)
```csharp
var productDetails = await context.Products
    .Join(context.Categories,
        p => p.CategoryId,
        c => c.Id,
        (p, c) => new 
        {
            ProductName = p.Name,
            CategoryName = c.Name,
            Price = p.Price
        })
    .ToListAsync();
```

## 4. 高级查询技术

### 原生 SQL 查询
```csharp
var expensiveProducts = await context.Products
    .FromSqlRaw("SELECT * FROM Products WHERE Price > 1000")
    .ToListAsync();

// 带参数
decimal minPrice = 1000;
var expensiveProductsSafe = await context.Products
    .FromSqlInterpolated($"SELECT * FROM Products WHERE Price > {minPrice}")
    .ToListAsync();
```

### 跟踪与非跟踪查询
```csharp
// 默认是跟踪查询(适合更新操作)
var trackedProduct = await context.Products.FindAsync(1);

// 非跟踪查询(适合只读操作，性能更好)
var untrackedProduct = await context.Products
    .AsNoTracking()
    .FirstOrDefaultAsync(p => p.Id == 1);
```

### 批量操作
```csharp
// 批量更新
await context.Products
    .Where(p => p.Price > 1000)
    .ExecuteUpdateAsync(p => p
        .SetProperty(x => x.Price, x => x.Price * 0.9m)); // 打9折

// 批量删除
await context.Products
    .Where(p => p.Price < 100)
    .ExecuteDeleteAsync();
```

## 5. 使用 DbContext 的最佳实践

1. **DbContext 生命周期**:
   - 通常每个工作单元创建一个新的 DbContext 实例
   - 在 Web 应用中，通常每个请求创建一个 DbContext

2. **性能优化**:
   ```csharp
   // 禁用跟踪以提高查询性能
   var products = await context.Products
       .AsNoTracking()
       .ToListAsync();
       
   // 只选择需要的列
   var productNames = await context.Products
       .Select(p => p.Name)
       .ToListAsync();
   ```

3. **事务处理**:
   ```csharp
   using var transaction = await context.Database.BeginTransactionAsync();
   try
   {
       // 多个操作
       context.Products.Add(new Product { ... });
       await context.SaveChangesAsync();
       
       context.Categories.Add(new Category { ... });
       await context.SaveChangesAsync();
       
       await transaction.CommitAsync();
   }
   catch
   {
       await transaction.RollbackAsync();
       throw;
   }
   ```

## 6. 使用 EF Core Tools 进行迁移

### 常用命令
```bash
# 添加迁移
Add-Migration InitialCreate

# 更新数据库
Update-Database

# 生成SQL脚本(不执行)
Script-Migration

# 移除最后一次迁移
Remove-Migration
```

### 示例迁移流程
1. 修改实体类
2. 在包管理器控制台运行:
   ```bash
   Add-Migration AddProductDescription
   Update-Database
   ```

这些是使用 Entity Framework Core 与 SQL Server 进行基本 LINQ 操作的核心技术。根据实际应用需求，可以组合使用这些技术来构建复杂的数据访问层。