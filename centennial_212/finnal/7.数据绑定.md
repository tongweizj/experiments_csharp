# WPF ComboBox 数据绑定完整案例

下面我将详细介绍一个完整的 WPF ComboBox 数据绑定案例，包括数据加载、选择项更新和 MVVM 模式下的实现。

## 案例场景
假设我们有一个订单管理系统，需要实现以下功能：
1. 在添加商品界面显示商品分类的下拉列表(ComboBox)
2. 当选择某个分类后，商品列表自动更新为对应分类的商品
3. 选择商品后可以设置数量并添加到订单

## 文件结构
```
- Models/
  - ProductCategory.cs
  - Product.cs
- ViewModels/
  - ProductCategoryViewModel.cs
  - ProductViewModel.cs
  - AddProductViewModel.cs
- Views/
  - AddProductView.xaml
  - AddProductView.xaml.cs
```

## 1. 模型层 (Models)

### ProductCategory.cs
```csharp
public class ProductCategory
{
    public int Id { get; set; }
    public string Name { get; set; }
}
```

### Product.cs
```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public int CategoryId { get; set; } // 外键关联分类
}
```

## 2. ViewModel 层

### ProductCategoryViewModel.cs
```csharp
public class ProductCategoryViewModel : ViewModelBase
{
    private readonly ProductCategory _model;
    
    public ProductCategoryViewModel(ProductCategory model)
    {
        _model = model;
    }
    
    public int Id => _model.Id;
    
    public string Name
    {
        get => _model.Name;
        set
        {
            _model.Name = value;
            RaisePropertyChanged();
        }
    }
}
```

### ProductViewModel.cs
```csharp
public class ProductViewModel : ViewModelBase
{
    private readonly Product _model;
    
    public ProductViewModel(Product model)
    {
        _model = model;
    }
    
    public int Id => _model.Id;
    
    public string Name
    {
        get => _model.Name;
        set
        {
            _model.Name = value;
            RaisePropertyChanged();
        }
    }
    
    public decimal Price => _model.Price;
    
    public int CategoryId => _model.CategoryId;
}
```

### AddProductViewModel.cs
```csharp
public class AddProductViewModel : ViewModelBase
{
    private readonly IDataService _dataService;
    
    // 分类列表
    public ObservableCollection<ProductCategoryViewModel> Categories { get; } = new();
    
    // 商品列表
    public ObservableCollection<ProductViewModel> Products { get; } = new();
    
    // 选中的分类
    private ProductCategoryViewModel _selectedCategory;
    public ProductCategoryViewModel SelectedCategory
    {
        get => _selectedCategory;
        set
        {
            if (SetProperty(ref _selectedCategory, value))
            {
                LoadProductsByCategory();
            }
        }
    }
    
    // 选中的商品
    private ProductViewModel _selectedProduct;
    public ProductViewModel SelectedProduct
    {
        get => _selectedProduct;
        set => SetProperty(ref _selectedProduct, value);
    }
    
    // 数量
    private int _quantity = 1;
    public int Quantity
    {
        get => _quantity;
        set => SetProperty(ref _quantity, value);
    }
    
    public AddProductViewModel(IDataService dataService)
    {
        _dataService = dataService;
        LoadCategories();
    }
    
    private async void LoadCategories()
    {
        var categories = await _dataService.GetAllCategoriesAsync();
        Categories.Clear();
        
        foreach (var category in categories)
        {
            Categories.Add(new ProductCategoryViewModel(category));
        }
        
        // 默认选择第一个分类
        if (Categories.Count > 0)
        {
            SelectedCategory = Categories[0];
        }
    }
    
    private async void LoadProductsByCategory()
    {
        if (SelectedCategory == null) return;
        
        var products = await _dataService.GetProductsByCategoryAsync(SelectedCategory.Id);
        Products.Clear();
        
        foreach (var product in products)
        {
            Products.Add(new ProductViewModel(product));
        }
        
        // 重置选中的商品
        SelectedProduct = null;
    }
    
    public ICommand AddToOrderCommand => new RelayCommand(AddToOrder);
    
    private void AddToOrder()
    {
        if (SelectedProduct == null || Quantity <= 0)
        {
            // 显示错误信息
            return;
        }
        
        // 添加到订单逻辑
        // ...
    }
}
```

## 3. View 层

### AddProductView.xaml
```xml
<UserControl x:Class="YourNamespace.Views.AddProductView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- 分类选择 ComboBox -->
        <Label Grid.Row="0" Content="选择分类:"/>
        <ComboBox Grid.Row="1" 
                  ItemsSource="{Binding Categories}"
                  DisplayMemberPath="Name"
                  SelectedValuePath="Id"
                  SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                  Margin="0,0,0,10"/>
        
        <!-- 商品选择 ComboBox -->
        <Label Grid.Row="2" Content="选择商品:"/>
        <ComboBox Grid.Row="3" 
                  ItemsSource="{Binding Products}"
                  DisplayMemberPath="Name"
                  SelectedItem="{Binding SelectedProduct, Mode=TwoWay}"
                  Margin="0,0,0,10"/>
        
        <!-- 数量输入 -->
        <Label Grid.Row="4" Content="数量:"/>
        <TextBox Grid.Row="5" 
                 Text="{Binding Quantity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                 Margin="0,0,0,10"/>
        
        <!-- 添加按钮 -->
        <Button Grid.Row="6" 
                Content="添加到订单"
                Command="{Binding AddToOrderCommand}"
                HorizontalAlignment="Right"
                Width="100"/>
    </Grid>
</UserControl>
```

### AddProductView.xaml.cs
```csharp
public partial class AddProductView : UserControl
{
    public AddProductView()
    {
        InitializeComponent();
        DataContext = new AddProductViewModel(new DataService());
    }
}
```

## 4. 数据服务层 (可选)

### IDataService.cs
```csharp
public interface IDataService
{
    Task<IEnumerable<ProductCategory>> GetAllCategoriesAsync();
    Task<IEnumerable<Product>> GetProductsByCategoryAsync(int categoryId);
}
```

### DataService.cs
```csharp
public class DataService : IDataService
{
    public async Task<IEnumerable<ProductCategory>> GetAllCategoriesAsync()
    {
        // 实际项目中这里是从数据库或API获取数据
        return new List<ProductCategory>
        {
            new ProductCategory { Id = 1, Name = "电子产品" },
            new ProductCategory { Id = 2, Name = "食品" },
            new ProductCategory { Id = 3, Name = "服装" }
        };
    }
    
    public async Task<IEnumerable<Product>> GetProductsByCategoryAsync(int categoryId)
    {
        // 模拟数据
        var allProducts = new List<Product>
        {
            new Product { Id = 1, Name = "笔记本电脑", Price = 5999, CategoryId = 1 },
            new Product { Id = 2, Name = "智能手机", Price = 3999, CategoryId = 1 },
            new Product { Id = 3, Name = "苹果", Price = 10, CategoryId = 2 },
            new Product { Id = 4, Name = "香蕉", Price = 5, CategoryId = 2 },
            new Product { Id = 5, Name = "T恤", Price = 99, CategoryId = 3 },
            new Product { Id = 6, Name = "牛仔裤", Price = 199, CategoryId = 3 }
        };
        
        return allProducts.Where(p => p.CategoryId == categoryId);
    }
}
```

## 关键点说明

1. **ComboBox 数据绑定**:
   - `ItemsSource` 绑定到 ViewModel 中的集合属性
   - `DisplayMemberPath` 指定显示的内容
   - `SelectedItem` 双向绑定到 ViewModel 中的选中项属性

2. **选择项更新逻辑**:
   - 当 `SelectedCategory` 改变时，自动加载对应分类的商品
   - 使用 `SetProperty` 方法确保属性变更时触发通知

3. **MVVM 分层**:
   - Model: 纯数据对象
   - ViewModel: 处理业务逻辑和UI逻辑
   - View: 只负责显示和用户交互

4. **数据加载**:
   - 异步加载数据，避免UI卡顿
   - 使用 ObservableCollection 自动通知UI更新

这个案例完整展示了如何在 WPF 中使用 MVVM 模式实现 ComboBox 的数据绑定和选择项更新逻辑。